#!/usr/bin/env node

/**
 * A11y Report Generator
 *
 * Reads individual axe-core test results and generates the compliance.json
 * file used by the A11yResultsSection component.
 *
 * FEATURES:
 * - Per-example pass/fail tracking for the variant dropdown
 * - Contrast ratio extraction (actual vs required) for color-contrast failures
 * - Light and dark mode results
 *
 * THRESHOLD RULES:
 * - pass: 0 violations
 * - fail: any violations
 * - no_examples: page had no example containers
 *
 * LEVEL MAPPING (signal only, not certification):
 * - pass ‚Üí "AA" (we tested with wcag2aa rules)
 * - fail ‚Üí undefined
 * - no_examples ‚Üí undefined
 */

import * as fs from "fs";
import * as path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Paths
const resultsDir = path.join(__dirname, "..", "test-results", "a11y-components");
const outputPath = path.join(__dirname, "..", "src", "docs", "registry", "compliance.json");

/**
 * Determine level achieved (signal only)
 */
function determineLevelAchieved(status) {
  return status === "pass" ? "AA" : undefined;
}

/**
 * Get combined status from both modes
 */
function getCombinedStatus(lightStatus, darkStatus) {
  if (lightStatus === "no_examples" && darkStatus === "no_examples") return "no_examples";
  if (lightStatus === "no_examples") return darkStatus;
  if (darkStatus === "no_examples") return lightStatus;
  
  if (lightStatus === "pass" && darkStatus === "pass") return "pass";
  if (lightStatus === "fail" && darkStatus === "fail") return "fail";
  
  // Mixed: one passes, one fails
  return "partial";
}

/**
 * Transform mode result to include examples object
 */
function transformModeResult(modeResult) {
  if (!modeResult) return null;
  
  const status = modeResult.status || "no_examples";
  
  return {
    status,
    levelAchieved: determineLevelAchieved(status),
    violations: modeResult.violations || 0,
    issues: modeResult.issues || [],
    examplesFound: modeResult.examplesFound || 0,
    failingElements: modeResult.failingElements || [],
    // NEW: Per-example results for the dropdown
    examples: modeResult.examples || {},
    examplesTested: modeResult.examplesTested || [],
    examplesSkipped: modeResult.examplesSkipped || [],
    // Count of passed/failed examples
    examplesPassed: Object.values(modeResult.examples || {}).filter(e => e.status === "pass").length,
    examplesFailed: Object.values(modeResult.examples || {}).filter(e => e.status === "fail").length,
  };
}

function main() {
  console.log("Generating A11y compliance report...\n");
  console.log("Scope: component-examples-only (docs UI excluded)");
  console.log("Modes: light + dark\n");

  // Check if results directory exists
  if (!fs.existsSync(resultsDir)) {
    console.error(`Error: Results directory not found at ${resultsDir}`);
    console.error("Run 'npm run test:a11y' first to generate test results.");
    process.exit(1);
  }

  // Read all individual result files
  const resultFiles = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));
  console.log(`Found ${resultFiles.length} component results...\n`);

  if (resultFiles.length === 0) {
    console.error("No result files found. Run tests first.");
    process.exit(1);
  }

  // Build compliance report
  const compliance = {
    _meta: {
      description: "A11y test results - generated by npm run test:a11y",
      scope: "component-examples-only",
      scopeDescription: "Scanned all [data-testid='component-example'] containers per page, excluding docs UI",
      rulesetCoverage: "automated (wcag2a, wcag2aa, wcag21a, wcag21aa, wcag22aa)",
      modes: ["light", "dark"],
      lastUpdated: new Date().toISOString(),
      totalComponents: resultFiles.length,
    }
  };

  let passCount = 0;
  let partialCount = 0;
  let failCount = 0;
  let noExamplesCount = 0;

  for (const file of resultFiles) {
    const filePath = path.join(resultsDir, file);
    const result = JSON.parse(fs.readFileSync(filePath, "utf-8"));

    const lightResult = result.modes?.light;
    const darkResult = result.modes?.dark;
    
    const lightStatus = lightResult?.status || "no_examples";
    const darkStatus = darkResult?.status || "no_examples";
    
    const combinedStatus = getCombinedStatus(lightStatus, darkStatus);
    const combinedLevel = determineLevelAchieved(combinedStatus);

    // Get all unique example IDs from both modes
    const allExampleIds = new Set([
      ...Object.keys(lightResult?.examples || {}),
      ...Object.keys(darkResult?.examples || {}),
    ]);

    compliance[result.key] = {
      status: combinedStatus,
      levelAchieved: combinedLevel,
      violations: result.violations || 0,
      issues: result.issues || [],
      testedAt: result.testedAt,
      scope: result.scope || "component-examples-only",
      examplesFound: result.examplesFound || 0,
      scenariosTested: Array.from(allExampleIds),
      subject: `Component examples for ${result.name}`,
      
      // Mode-specific results with per-example breakdown
      modes: {
        light: transformModeResult(lightResult),
        dark: transformModeResult(darkResult),
      },
    };

    // Count and log status
    if (combinedStatus === "pass") passCount++;
    else if (combinedStatus === "partial") partialCount++;
    else if (combinedStatus === "no_examples") noExamplesCount++;
    else failCount++;

    const lightIcon = lightStatus === "pass" ? "‚úÖ" : lightStatus === "no_examples" ? "üö´" : "‚ùå";
    const darkIcon = darkStatus === "pass" ? "‚úÖ" : darkStatus === "no_examples" ? "üö´" : "‚ùå";
    
    console.log(`${result.name}: Light ${lightIcon} | Dark ${darkIcon}`);
  }

  // Write compliance.json
  fs.writeFileSync(outputPath, JSON.stringify(compliance, null, 2));
  console.log(`\n‚úÖ Compliance report written to: ${outputPath}`);

  // Summary
  console.log("\n--- Summary ---");
  console.log(`Pass: ${passCount}`);
  console.log(`Partial: ${partialCount}`);
  console.log(`Fail: ${failCount}`);
  if (noExamplesCount > 0) {
    console.log(`No Examples: ${noExamplesCount} ‚ö†Ô∏è`);
  }
  console.log(`Total: ${resultFiles.length}`);
}

main();
